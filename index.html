<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stochastic Sequencer with OSC Bridge</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .config-section {
      background-color: #e0e0e0;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    label {
      display: inline-block;
      width: 120px;
      margin-right: 10px;
    }
    input, select {
      padding: 5px;
      margin-right: 15px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    button.disconnect {
      background-color: #f44336;
    }
    #serverStatus, #oscStatus {
      color: #333;
      font-size: 14px;
      margin-top: 10px;
    }
    #synthControls {
      background-color: #e0e0e0;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .osc-message {
      font-family: monospace;
      margin: 2px 0;
      padding: 2px 5px;
      background-color: #eee;
      border-radius: 3px;
    }
    #pythonStatus {
      font-family: monospace;
      white-space: pre;
      background-color: #333;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/osc/dist/osc-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>
  <h1>Stochastic Sequencer with OSC Bridge</h1>
  
  <div class="config-section">
    <h2>Embedded Python Bridge</h2>
    <div id="pythonStatus">Initializing Python bridge...</div>
    <div>
      <label for="udpTargetIp">UDP Target IP:</label>
      <input type="text" id="udpTargetIp" value="127.0.0.1">
      
      <label for="udpTargetPort">UDP Target Port:</label>
      <input type="number" id="udpTargetPort" value="8000" min="1024" max="65535">
      
      <button id="updateUdpTarget">Update UDP Target</button>
    </div>
  </div>

  <div class="config-section">
    <h2>Bridge Configuration</h2>
    <div>
      <label for="bridgeIp">Bridge IP:</label>
      <input type="text" id="bridgeIp" value="127.0.0.1">
      
      <label for="bridgePort">Bridge Port:</label>
      <input type="number" id="bridgePort" value="9000" min="1024" max="65535">
      
      <button id="updateBridgeConfig">Update Bridge</button>
    </div>
    <div id="serverStatus">Local WebSocket server: Stopped</div>
  </div>
  
  <!-- Rest of your existing HTML remains the same -->
  <!-- ... -->

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize Pyodide
      let pyodide;
      let pythonBridgeActive = false;
      const pythonStatus = document.getElementById('pythonStatus');
      
   async function initPyodide() {
  try {
    console.log("STEP 1: Starting Pyodide load");
    pythonStatus.textContent = "Loading Pyodide...";
    
    pyodide = await loadPyodide({
      indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
    });

    console.log("STEP 2: Pyodide loaded");

    await pyodide.loadPackage("micropip");
    console.log("STEP 3: micropip loaded");

    const micropip = pyodide.pyimport("micropip");
    console.log("STEP 4: micropip imported");

    await micropip.install("websockets");
    console.log("STEP 5: websockets installed");

    await micropip.install("python-osc");
    console.log("STEP 6: python-osc installed");

    pythonStatus.textContent = "Python bridge ready!\n";
    return true;

  } catch (e) {
    console.error("PYODIDE INIT ERROR:", e);
    pythonStatus.textContent = `Python bridge failed to load:\n${e}`;
    return false;
  }
}

  const code = `
import asyncio
import websockets
from pythonosc import udp_client, osc_message_builder

udp_target = udp_client.SimpleUDPClient("${udpIp}", ${udpPort})

async def handle_websocket(websocket, path):
    print(f"WebSocket connected: {path}")
    try:
        async for message in websocket:
            try:
                parts = message.split()
                if len(parts) >= 2:
                    address = parts[0]
                    args = [float(x) if x.replace('.', '', 1).isdigit() else x for x in parts[1:]]
                    msg = osc_message_builder.OscMessageBuilder(address=address)
                    for arg in args:
                        msg.add_arg(arg)
                    udp_target.send(msg.build())
                    print(f"Forwarded: {address} {args}")
            except Exception as e:
                print(f"Message processing error: {e}")
    except Exception as e:
        print(f"WebSocket handling error: {e}")

async def main():
    server = await websockets.serve(handle_websocket, "0.0.0.0", ${wsPort})
    print(f"WebSocket server started on port ${wsPort}, forwarding to UDP ${udpIp}:${udpPort}")
    await server.wait_closed()

asyncio.run(main())
`;


      
      // Initialize Python bridge
      const pyodideReady = await initPyodide();
      
      // Set default UDP target and start bridge
      document.getElementById('updateUdpTarget').addEventListener('click', function() {
        const udpIp = document.getElementById('udpTargetIp').value.trim();
        const udpPort = parseInt(document.getElementById('udpTargetPort').value);
        const wsPort = parseInt(document.getElementById('bridgePort').value);
        
        if (udpIp && udpPort >= 1024 && udpPort <= 65535) {
          if (pyodideReady) {
            startPythonBridge(udpIp, udpPort, wsPort);
          } else {
            updatePythonStatus("Python bridge not ready yet");
          }
        } else {
          updatePythonStatus("Invalid UDP target settings");
        }
      });
      
      // Auto-start with default values if Pyodide loaded successfully
      if (pyodideReady) {
        const udpIp = document.getElementById('udpTargetIp').value;
        const udpPort = parseInt(document.getElementById('udpTargetPort').value);
        const wsPort = parseInt(document.getElementById('bridgePort').value);
        startPythonBridge(udpIp, udpPort, wsPort);
      }

      // Rest of your existing JavaScript code
      // ... (all the original audio and OSC handling code remains the same)
      
      // Modify the bridge configuration update to restart Python bridge if needed
      document.getElementById('updateBridgeConfig').addEventListener('click', function() {
        const newIp = document.getElementById('bridgeIp').value.trim();
        const newPort = parseInt(document.getElementById('bridgePort').value);
        
        if (newIp && newPort >= 1024 && newPort <= 65535) {
          bridgeIp = newIp;
          bridgePort = newPort;
          updateBridgeDisplay();
          stopLocalServer();
          startLocalServer();
          
          // Restart Python bridge with new port if active
          if (pythonBridgeActive) {
            const udpIp = document.getElementById('udpTargetIp').value.trim();
            const udpPort = parseInt(document.getElementById('udpTargetPort').value);
            startPythonBridge(udpIp, udpPort, newPort);
          }
        }
      });
      
      // Initialize the rest of your application
      initAudio();
      updateBridgeDisplay();
      startLocalServer();
    });
  </script>
</body>
</html>