<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stochastic Sequencer with OSC Bridge</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .config-section {
      background-color: #e0e0e0;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    label {
      display: inline-block;
      width: 120px;
      margin-right: 10px;
    }
    input, select {
      padding: 5px;
      margin-right: 15px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    button.disconnect {
      background-color: #f44336;
    }
    #serverStatus, #oscStatus {
      color: #333;
      font-size: 14px;
      margin-top: 10px;
    }
    #synthControls {
      background-color: #e0e0e0;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .osc-message {
      font-family: monospace;
      margin: 2px 0;
      padding: 2px 5px;
      background-color: #eee;
      border-radius: 3px;
    }
    #pythonStatus {
      font-family: monospace;
      white-space: pre;
      background-color: #333;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/osc/dist/osc-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>
  <h1>Stochastic Sequencer with OSC Bridge</h1>
  
  <div class="config-section">
    <h2>Embedded Python Bridge</h2>
    <div id="pythonStatus">Initializing Python bridge...</div>
    <div>
      <label for="udpTargetIp">UDP Target IP:</label>
      <input type="text" id="udpTargetIp" value="127.0.0.1">
      
      <label for="udpTargetPort">UDP Target Port:</label>
      <input type="number" id="udpTargetPort" value="8000" min="1024" max="65535">
      
      <button id="updateUdpTarget">Update UDP Target</button>
    </div>
  </div>

  <div class="config-section">
    <h2>Bridge Configuration</h2>
    <div>
      <label for="bridgeIp">Bridge IP:</label>
      <input type="text" id="bridgeIp" value="127.0.0.1">
      
      <label for="bridgePort">Bridge Port:</label>
      <input type="number" id="bridgePort" value="9000" min="1024" max="65535">
      
      <button id="updateBridgeConfig">Update Bridge</button>
    </div>
    <div id="serverStatus">Local WebSocket server: Stopped</div>
  </div>
  
  <script>
    // Global variables
    let pyodide;
    let pythonBridgeActive = false;

    function updatePythonStatus(message) {
      const statusElement = document.getElementById('pythonStatus');
      statusElement.textContent = message;
      statusElement.scrollTop = statusElement.scrollHeight;
    }

    async function startPythonBridge(udpIp, udpPort, wsPort) {
      try {
        const formattedCode = `
import asyncio
import websockets
from pythonosc import udp_client, osc_message_builder

udp_target = udp_client.SimpleUDPClient("${udpIp}", ${udpPort})

async def handle_websocket(websocket, path):
    print(f"WebSocket connected: {path}")
    try:
        async for message in websocket:
            try:
                parts = message.split()
                if len(parts) >= 2:
                    address = parts[0]
                    args = [float(x) if x.replace('.', '', 1).isdigit() else x for x in parts[1:]]
                    msg = osc_message_builder.OscMessageBuilder(address=address)
                    for arg in args:
                        msg.add_arg(arg)
                    udp_target.send(msg.build())
                    print(f"Forwarded: {address} {args}")
            except Exception as e:
                print(f"Message processing error: {e}")
    except Exception as e:
        print(f"WebSocket handling error: {e}")

async def main():
    server = await websockets.serve(handle_websocket, "0.0.0.0", ${wsPort})
    print(f"WebSocket server started on port ${wsPort}, forwarding to UDP ${udpIp}:${udpPort}")
    await server.wait_closed()

asyncio.run(main())
`;

        await pyodide.runPythonAsync(formattedCode);
        pythonBridgeActive = true;
        updatePythonStatus(`Python bridge running\nForwarding to ${udpIp}:${udpPort}`);
      } catch (e) {
        console.error("Python bridge error:", e);
        updatePythonStatus(`Python bridge error:\n${e}`);
      }
    }

    document.addEventListener('DOMContentLoaded', async function() {
      updatePythonStatus("Starting Pyodide initialization...");
      
      try {
        pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
        });
        updatePythonStatus("Pyodide loaded, installing packages...");
        
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        
        updatePythonStatus("Installing websockets...");
        await micropip.install("websockets");
        
        updatePythonStatus("Installing python-osc...");
        await micropip.install("python-osc");
        
        updatePythonStatus("Python bridge ready!");
        
        // Start with default values
        const udpIp = document.getElementById('udpTargetIp').value.trim();
        const udpPort = parseInt(document.getElementById('udpTargetPort').value);
        const wsPort = parseInt(document.getElementById('bridgePort').value);
        await startPythonBridge(udpIp, udpPort, wsPort);
        
      } catch (e) {
        console.error("Initialization error:", e);
        updatePythonStatus(`Initialization failed:\n${e}`);
      }

      // Setup event listeners
      document.getElementById('updateUdpTarget').addEventListener('click', async function() {
        const udpIp = document.getElementById('udpTargetIp').value.trim();
        const udpPort = parseInt(document.getElementById('udpTargetPort').value);
        const wsPort = parseInt(document.getElementById('bridgePort').value);
        
        if (udpIp && udpPort >= 1024 && udpPort <= 65535) {
          await startPythonBridge(udpIp, udpPort, wsPort);
        } else {
          updatePythonStatus("Invalid UDP target settings");
        }
      });

      document.getElementById('updateBridgeConfig').addEventListener('click', function() {
        const newIp = document.getElementById('bridgeIp').value.trim();
        const newPort = parseInt(document.getElementById('bridgePort').value);
        
        if (newIp && newPort >= 1024 && newPort <= 65535) {
          bridgeIp = newIp;
          bridgePort = newPort;
          updateBridgeDisplay();
          stopLocalServer();
          startLocalServer();
          
          // Restart Python bridge with new port if active
          if (pythonBridgeActive) {
            const udpIp = document.getElementById('udpTargetIp').value.trim();
            const udpPort = parseInt(document.getElementById('udpTargetPort').value);
            startPythonBridge(udpIp, udpPort, newPort);
          }
        }
      });
    });

    // Rest of your existing functions (initAudio, updateBridgeDisplay, etc.)
    // These would need to be included as well for complete functionality
    function initAudio() {
      // Your audio initialization code
    }

    function updateBridgeDisplay() {
      // Your bridge display update code
    }

    function startLocalServer() {
      // Your local server start code
    }

    function stopLocalServer() {
      // Your local server stop code
    }
  </script>
</body>
</html>